name: Persistent RDP with OpenVPN

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        persist-credentials: true

    # تثبيت OpenVPN
    - name: Install OpenVPN
      run: choco install openvpn -y

    # الاتصال بالـ VPN (IP ثابت)
    - name: Connect to OpenVPN
      run: |
        $ovpnConfig = "${{ secrets.OPENVPN_CONFIG }}"
        Set-Content -Path "$env:TEMP\client.ovpn" -Value $ovpnConfig -Encoding UTF8
        Start-Process -FilePath "C:\Program Files\OpenVPN\bin\openvpn.exe" `
          -ArgumentList "--config `"$env:TEMP\client.ovpn`"" `
          -WindowStyle Hidden
        Start-Sleep -Seconds 25
        Write-Host "✅ OpenVPN Connected"

    # تفعيل RDP + استخدام حساب ثابت
    - name: Enable RDP and Use Persistent Account
      run: |
        $username = "PersistentRDP"
        $password = "admin@123"   # الباسورد ثابت

        # تفعيل RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

        # إنشاء الحساب فقط إذا لم يكن موجود
        if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force) -AccountNeverExpires
            Add-LocalGroupMember -Group "Administrators" -Member $username
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
            Write-Host "✅ Created Persistent RDP account: $username"
        } else {
            Write-Host "✅ Using existing RDP account: $username"
        }

        # حفظ البيانات في الملف s.txt
        $filePath = "s.txt"
        $vpnIP = (Invoke-WebRequest -Uri "http://ifconfig.me/ip").Content.Trim()
        $time = Get-Date -Format "yyyy-MM-dd HH:mm:ss"

        $entry = @"
=============================
Date: $time
Address: $vpnIP
Username: $username
Password: $password
=============================
"@

        Add-Content -Path $filePath -Value $entry
        Write-Host "✅ Added RDP info to file: $filePath"

        # رفع الملف للمستودع تلقائيًا
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add $filePath
        git commit -m "💻 Auto-update RDP info - $time" || echo "No changes to commit"
        git push origin HEAD
