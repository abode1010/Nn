name: Persistent RDP with OpenVPN and Auto-Save via API

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 1440

    steps:
      # ØªØ«Ø¨ÙŠØª OpenVPN
      - name: Install OpenVPN
        run: choco install openvpn -y

      # Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ OpenVPN
      - name: Connect to OpenVPN
        run: |
          $ovpnConfig = "${{ secrets.OPENVPN_CONFIG }}"
          $ovpnPath = "$env:ProgramData\OpenVPN\config\client.ovpn"

          if (-not (Test-Path $ovpnPath)) {
              New-Item -ItemType File -Path $ovpnPath -Force
              Set-Content -Path $ovpnPath -Value $ovpnConfig -Encoding UTF8
          }

          $vpnRunning = Get-Process openvpn -ErrorAction SilentlyContinue
          if (-not $vpnRunning) {
              Start-Process -FilePath "C:\Program Files\OpenVPN\bin\openvpn.exe" `
                -ArgumentList "--config `"$ovpnPath`"" `
                -WindowStyle Hidden
              Start-Sleep -Seconds 25
          }

      # ØªÙØ¹ÙŠÙ„ RDP ÙˆØ­Ø³Ø§Ø¨ Ø¯Ø§Ø¦Ù…
      - name: Enable RDP and Persistent Account
        run: |
          $username = "PersistentRDP"
          $password = "admin@123"

          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force) -AccountNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member $username
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          }

      # Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª RDP ÙÙŠ s.txt
      - name: Save RDP info locally
        run: |
          $filePath = "s.txt"
          $username = "PersistentRDP"
          $password = "admin@123"
          $vpnIP = (Invoke-WebRequest -Uri "http://ifconfig.me/ip").Content.Trim()
          $time = Get-Date -Format "yyyy-MM-dd HH:mm:ss"

          $entry = "=============================`nDate: $time`nAddress: $vpnIP`nUsername: $username`nPassword: $password`n=============================`n"
          Add-Content -Path $filePath -Value $entry

      # Ø±ÙØ¹ s.txt Ø¥Ù„Ù‰ Ù…Ø³ØªÙˆØ¯Ø¹ Nn Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… GitHub API ÙˆGH_PAT
      - name: Upload s.txt via GitHub API
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          $filePath = "s.txt"
          $repo = "abode1010/Nn"
          $branch = "main"
          $message = "ğŸ’» Auto-update RDP info"
          $content = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes((Get-Content $filePath -Raw)))
          $url = "https://api.github.com/repos/$repo/contents/$filePath"

          $response = Invoke-RestMethod -Uri "$url?ref=$branch" -Headers @{Authorization = "token $env:GH_PAT"} -Method GET -ErrorAction SilentlyContinue

          if ($response) {
              $sha = $response.sha
              $body = @{
                  message = $message
                  content = $content
                  branch = $branch
                  sha = $sha
              } | ConvertTo-Json
          } else {
              $body = @{
                  message = $message
                  content = $content
                  branch = $branch
              } | ConvertTo-Json
          }

          Invoke-RestMethod -Uri $url -Headers @{Authorization = "token $env:GH_PAT"} -Method PUT -Body $body
          Write-Host "âœ… s.txt uploaded/updated via API"

      # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Logs
      - name: Show RDP & VPN info
        run: |
          $username = "PersistentRDP"
          $password = "admin@123"
          $vpnIP = (Invoke-WebRequest -Uri "http://ifconfig.me/ip").Content.Trim()
          Write-Host "============================="
          Write-Host "âœ… RDP & VPN Info"
          Write-Host "Address (VPN IP): $vpnIP"
          Write-Host "Username: $username"
          Write-Host "Password: $password"
          Write-Host "============================="

      # Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø©
      - name: Keep Workflow Alive
        run: |
          Write-Host "ğŸ’» RDP & VPN are running. Keeping session alive..."
          while ($true) {
              Start-Sleep -Seconds 300
          }
