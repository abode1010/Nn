name: Persistent RDP with OpenVPN

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        persist-credentials: true

    # ØªØ«Ø¨ÙŠØª OpenVPN
    - name: Install OpenVPN
      run: choco install openvpn -y

    # Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ VPN (IP Ø«Ø§Ø¨Øª)
    - name: Connect to OpenVPN
      run: |
        $ovpnConfig = "${{ secrets.OPENVPN_CONFIG }}"
        Set-Content -Path "$env:TEMP\client.ovpn" -Value $ovpnConfig -Encoding UTF8
        Start-Process -FilePath "C:\Program Files\OpenVPN\bin\openvpn.exe" `
          -ArgumentList "--config `"$env:TEMP\client.ovpn`"" `
          -WindowStyle Hidden
        Start-Sleep -Seconds 25
        Write-Host "âœ… OpenVPN Connected"

    # ØªÙØ¹ÙŠÙ„ RDP + Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨ Ø«Ø§Ø¨Øª
    - name: Enable RDP and Use Persistent Account
      run: |
        $username = "PersistentRDP"
        $password = "admin@123"   # Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø«Ø§Ø¨Øª

        # ØªÙØ¹ÙŠÙ„ RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
        if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force) -AccountNeverExpires
            Add-LocalGroupMember -Group "Administrators" -Member $username
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
            Write-Host "âœ… Created Persistent RDP account: $username"
        } else {
            Write-Host "âœ… Using existing RDP account: $username"
        }

        # Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù s.txt
        $filePath = "s.txt"
        $vpnIP = (Invoke-WebRequest -Uri "http://ifconfig.me/ip").Content.Trim()
        $time = Get-Date -Format "yyyy-MM-dd HH:mm:ss"

        $entry = @"
=============================
Date: $time
Address: $vpnIP
Username: $username
Password: $password
=============================
"@

        Add-Content -Path $filePath -Value $entry
        Write-Host "âœ… Added RDP info to file: $filePath"

        # Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add $filePath
        git commit -m "ğŸ’» Auto-update RDP info - $time" || echo "No changes to commit"
        git push origin HEAD
